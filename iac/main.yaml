# main.yaml
# CloudFormation template for HA Web Platform
# VPC with 2 AZs, public/private subnets, ALB, ASG, DynamoDB, CloudWatch
# Uses LabInstanceProfile for EC2 instances in lab environments

AWSTemplateFormatVersion: '2010-09-09'
Description: HA Web Platform. VPC, subnets, routing, NAT, ALB, ASG, EC2, DynamoDB, security groups, basic monitoring.

Parameters:
  ResourcePrefix:
    Type: String
    Default: infra-ha-web-dev
    Description: Resource prefix for all infrastructure components. Used for Name tags and deterministic naming (e.g., DynamoDB table, security groups, subnets).

  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - test
      - prod
    Description: Environment identifier used for tagging.

  CreateDdbVpcEndpoint:
    Type: String
    Default: 'yes'
    AllowedValues:
      - 'yes'
      - 'no'
    Description: Create a DynamoDB gateway endpoint. Some lab roles may block this action.

  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for the VPC.

  PublicSubnet1Cidr:
    Type: String
    Default: 10.0.1.0/24
    Description: CIDR block for public subnet in AZ1.

  PublicSubnet2Cidr:
    Type: String
    Default: 10.0.2.0/24
    Description: CIDR block for public subnet in AZ2.

  PrivateSubnet1Cidr:
    Type: String
    Default: 10.0.11.0/24
    Description: CIDR block for private subnet in AZ1.

  PrivateSubnet2Cidr:
    Type: String
    Default: 10.0.12.0/24
    Description: CIDR block for private subnet in AZ2.

  InstanceType:
    Type: String
    Default: t2.micro
    AllowedValues:
      - t2.micro
      - t3.micro
    Description: EC2 instance type for the Auto Scaling group.

  DesiredCapacity:
    Type: Number
    Default: 2
    Description: Desired number of instances in the Auto Scaling group.

  MinSize:
    Type: Number
    Default: 2
    Description: Minimum number of instances in the Auto Scaling group.

  MaxSize:
    Type: Number
    Default: 2
    Description: Maximum number of instances in the Auto Scaling group.

  ImageId:
    Type: AWS::EC2::Image::Id
    Default: ami-022bee044edfca8f1
    Description: Amazon Linux 2 AMI ID.

Conditions:
  CreateDdbEndpointCondition: !Equals [!Ref CreateDdbVpcEndpoint, 'yes']

Resources:
  # ============================================================================
  # NOTE: IAM Role and Instance Profile are NOT created here.
  # The lab environment provides LabInstanceProfile with LabRole pre-configured.
  # EC2 instances will use LabInstanceProfile which has DynamoDB permissions.
  # ============================================================================

  # ============================================================================
  # Network Resources - VPC and Subnets
  # ============================================================================
  HaWebVpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-vpc'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'Core VPC for HA Web Platform - spans 2 AZs'
        - Key: Tier
          Value: 'Network'

  HaWebInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-igw'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'Internet Gateway for public subnet egress'
        - Key: Tier
          Value: 'Network'

  HaWebVpcGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref HaWebVpc
      InternetGatewayId: !Ref HaWebInternetGateway

  HaWebPublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref HaWebVpc
      CidrBlock: !Ref PublicSubnet1Cidr
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-subnet-public-az1'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'Public subnet in AZ1 for ALB and NAT Gateway'
        - Key: Tier
          Value: 'Network-Public'

  HaWebPublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref HaWebVpc
      CidrBlock: !Ref PublicSubnet2Cidr
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-subnet-public-az2'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'Public subnet in AZ2 for ALB redundancy'
        - Key: Tier
          Value: 'Network-Public'

  HaWebPrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref HaWebVpc
      CidrBlock: !Ref PrivateSubnet1Cidr
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-subnet-private-az1'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'Private subnet in AZ1 for EC2 instances'
        - Key: Tier
          Value: 'Network-Private'

  HaWebPrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref HaWebVpc
      CidrBlock: !Ref PrivateSubnet2Cidr
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-subnet-private-az2'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'Private subnet in AZ2 for EC2 instances'
        - Key: Tier
          Value: 'Network-Private'

  HaWebPublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref HaWebVpc
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-rt-public'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'Route table for public subnets - routes to IGW'
        - Key: Tier
          Value: 'Network'

  HaWebPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: HaWebVpcGatewayAttachment
    Properties:
      RouteTableId: !Ref HaWebPublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref HaWebInternetGateway

  HaWebPublicSubnet1Association:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref HaWebPublicSubnet1
      RouteTableId: !Ref HaWebPublicRouteTable

  HaWebPublicSubnet2Association:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref HaWebPublicSubnet2
      RouteTableId: !Ref HaWebPublicRouteTable

  HaWebPrivateSubnet1Association:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DependsOn:
      - HaWebPrivateRoute
    Properties:
      SubnetId: !Ref HaWebPrivateSubnet1
      RouteTableId: !Ref HaWebPrivateRouteTable

  HaWebPrivateSubnet2Association:
    Type: AWS::EC2::SubnetRouteTableAssociation
    DependsOn:
      - HaWebPrivateRoute
    Properties:
      SubnetId: !Ref HaWebPrivateSubnet2
      RouteTableId: !Ref HaWebPrivateRouteTable

  HaWebNatEip:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-eip-nat'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'Elastic IP for NAT Gateway'
        - Key: Tier
          Value: 'Network'

  HaWebNatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt HaWebNatEip.AllocationId
      SubnetId: !Ref HaWebPublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-nat'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'NAT Gateway for private subnet egress'
        - Key: Tier
          Value: 'Network'

  HaWebPrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref HaWebVpc
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-rt-private'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'Route table for private subnets - routes to NAT'
        - Key: Tier
          Value: 'Network'

  HaWebPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref HaWebPrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref HaWebNatGateway

  HaWebAlbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow inbound HTTP from the Internet to the ALB.
      VpcId: !Ref HaWebVpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-sg-alb'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'Security group for ALB - allows HTTP 80 from Internet'
        - Key: Tier
          Value: 'Security'

  HaWebEc2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow inbound HTTP only from the ALB security group. No public SSH.
      VpcId: !Ref HaWebVpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref HaWebAlbSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-sg-ec2'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'Security group for EC2 - HTTP from ALB only, no SSH'
        - Key: Tier
          Value: 'Security'

  HaWebApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Scheme: internet-facing
      Subnets:
        - !Ref HaWebPublicSubnet1
        - !Ref HaWebPublicSubnet2
      SecurityGroups:
        - !Ref HaWebAlbSecurityGroup
      Type: application
      IpAddressType: ipv4
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-alb'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'Application Load Balancer - internet-facing layer 7'
        - Key: Tier
          Value: 'Compute'

  HaWebTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Port: 80
      Protocol: HTTP
      VpcId: !Ref HaWebVpc
      TargetType: instance
      HealthCheckPath: /health.html
      Matcher:
        HttpCode: 200
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-tg'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'Target group for EC2 instances - HTTP health checks'
        - Key: Tier
          Value: 'Compute'

  HaWebAlbListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref HaWebApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref HaWebTargetGroup

  HaWebLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    DependsOn: HaWebDynamoDbTable
    Properties:
      LaunchTemplateData:
        ImageId: !Ref ImageId
        InstanceType: !Ref InstanceType
        IamInstanceProfile:
          Name: LabInstanceProfile
        SecurityGroupIds:
          - !Ref HaWebEc2SecurityGroup
        UserData:
          Fn::Base64: !Sub |
            #!/usr/bin/env bash
            set -euo pipefail
            
            # System setup
            yum update -y
            yum install -y httpd jq
            systemctl enable httpd
            systemctl start httpd
            
            # Collect instance metadata
            INSTANCE_ID="$(curl -s http://169.254.169.254/latest/meta-data/instance-id)"
            AZ="$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)"
            PRIVATE_IP="$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)"
            INSTANCE_TYPE="$(curl -s http://169.254.169.254/latest/meta-data/instance-type)"
            HOSTNAME="$(hostname)"
            LAUNCH_TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            TABLE_NAME='${ResourcePrefix}-ddb'
            REGION='${AWS::Region}'
            
            # Register instance in DynamoDB
            aws dynamodb put-item \
              --table-name "$TABLE_NAME" \
              --region "$REGION" \
              --item "{
                \"id\": {\"S\": \"$INSTANCE_ID\"},
                \"az\": {\"S\": \"$AZ\"},
                \"private_ip\": {\"S\": \"$PRIVATE_IP\"},
                \"instance_type\": {\"S\": \"$INSTANCE_TYPE\"},
                \"hostname\": {\"S\": \"$HOSTNAME\"},
                \"launch_time\": {\"S\": \"$LAUNCH_TIME\"},
                \"environment\": {\"S\": \"${Environment}\"},
                \"status\": {\"S\": \"running\"}
              }" || echo "DynamoDB write failed - continuing anyway"
            
            # Query DynamoDB for all registered instances
            DDB_INSTANCES=$(aws dynamodb scan \
              --table-name "$TABLE_NAME" \
              --region "$REGION" \
              --query 'Items[*].[id.S,az.S,private_ip.S,launch_time.S]' \
              --output text 2>/dev/null || echo "")
            
            # Build instance table rows
            INSTANCE_ROWS=""
            while IFS=$'\t' read -r id az ip launch; do
              if [[ -n "$id" ]]; then
                INSTANCE_ROWS="$INSTANCE_ROWS<tr><td>$id</td><td>$az</td><td>$ip</td><td>$launch</td></tr>"
              fi
            done <<< "$DDB_INSTANCES"
            
            # Create dynamic web page
            cat <<EOF > /var/www/html/index.html
            <!DOCTYPE html>
            <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta http-equiv="refresh" content="30">
              <title>HA Web Platform - ${ResourcePrefix}</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                h1 { color: #232f3e; border-bottom: 3px solid #ff9900; padding-bottom: 10px; }
                h2 { color: #232f3e; margin-top: 30px; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
                .info-box { background: #f9f9f9; padding: 15px; border-radius: 5px; border-left: 4px solid #ff9900; }
                .info-box strong { color: #232f3e; display: block; margin-bottom: 5px; }
                .info-box span { color: #666; font-family: monospace; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th { background: #232f3e; color: white; padding: 12px; text-align: left; }
                td { padding: 10px; border-bottom: 1px solid #ddd; font-family: monospace; font-size: 0.9em; }
                tr:hover { background: #f5f5f5; }
                .status { display: inline-block; padding: 3px 10px; border-radius: 3px; background: #4caf50; color: white; }
                .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 0.9em; }
              </style>
            </head>
            <body>
              <div class="container">
                <h1>HA Web Platform</h1>
                <p><span class="status">Running</span> This instance is part of an Auto Scaling Group behind an Application Load Balancer.</p>
                
                <h2>Current Instance</h2>
                <div class="info-grid">
                  <div class="info-box"><strong>Instance ID</strong><span>$INSTANCE_ID</span></div>
                  <div class="info-box"><strong>Availability Zone</strong><span>$AZ</span></div>
                  <div class="info-box"><strong>Private IP</strong><span>$PRIVATE_IP</span></div>
                  <div class="info-box"><strong>Instance Type</strong><span>$INSTANCE_TYPE</span></div>
                  <div class="info-box"><strong>Hostname</strong><span>$HOSTNAME</span></div>
                  <div class="info-box"><strong>Launch Time</strong><span>$LAUNCH_TIME</span></div>
                  <div class="info-box"><strong>Environment</strong><span>${Environment}</span></div>
                  <div class="info-box"><strong>Resource Prefix</strong><span>${ResourcePrefix}</span></div>
                </div>
                
                <h2>DynamoDB Integration</h2>
                <div class="info-grid">
                  <div class="info-box"><strong>Table Name</strong><span>$TABLE_NAME</span></div>
                  <div class="info-box"><strong>Region</strong><span>$REGION</span></div>
                </div>
                
                <h2>All Registered Instances (from DynamoDB)</h2>
                <table>
                  <tr><th>Instance ID</th><th>Availability Zone</th><th>Private IP</th><th>Launch Time</th></tr>
                  $INSTANCE_ROWS
                </table>
                
                <div class="footer">
                  <p><strong>Architecture:</strong> VPC with public/private subnets across 2 AZs | ALB | ASG | DynamoDB</p>
                  <p>Page auto-refreshes every 30 seconds. Refresh the page to see load balancing across instances.</p>
                </div>
              </div>
            </body>
            </html>
            EOF
            
            # Create health check page
            echo "OK" > /var/www/html/health.html
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub '${ResourcePrefix}-i'
              - Key: Project
                Value: ha-web-platform
              - Key: Environment
                Value: !Ref Environment
              - Key: Description
                Value: 'EC2 instance - web server in private subnet'
              - Key: Tier
                Value: 'Compute'

  HaWebAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier:
        - !Ref HaWebPrivateSubnet1
        - !Ref HaWebPrivateSubnet2
      LaunchTemplate:
        LaunchTemplateId: !Ref HaWebLaunchTemplate
        Version: !GetAtt HaWebLaunchTemplate.LatestVersionNumber
      MinSize: !Ref MinSize
      MaxSize: !Ref MaxSize
      DesiredCapacity: !Ref DesiredCapacity
      TargetGroupARNs:
        - !Ref HaWebTargetGroup
      HealthCheckType: ELB
      HealthCheckGracePeriod: 90
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-asg'
          PropagateAtLaunch: true
        - Key: Project
          Value: ha-web-platform
          PropagateAtLaunch: true
        - Key: Environment
          Value: !Ref Environment
          PropagateAtLaunch: true
        - Key: Description
          Value: 'Auto Scaling Group - manages EC2 capacity'
          PropagateAtLaunch: false
        - Key: Tier
          Value: 'Compute'
          PropagateAtLaunch: false

  HaWebDynamoDbTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ResourcePrefix}-ddb'
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-ddb'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'DynamoDB table - managed NoSQL with encryption'
        - Key: Tier
          Value: 'Database'

  HaWebVpcEndpointDynamoDb:
    Type: AWS::EC2::VPCEndpoint
    Condition: CreateDdbEndpointCondition
    Properties:
      VpcId: !Ref HaWebVpc
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.dynamodb'
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref HaWebPrivateRouteTable
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-vpce-ddb'
        - Key: Project
          Value: ha-web-platform
        - Key: Environment
          Value: !Ref Environment
        - Key: Description
          Value: 'VPC Gateway Endpoint for private DynamoDB access'
        - Key: Tier
          Value: 'Network'

  HaWebCpuAlarmHigh:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Example alarm when average CPU is high across the Auto Scaling group.
      Namespace: AWS/EC2
      MetricName: CPUUtilization
      Statistic: Average
      Period: 60
      EvaluationPeriods: 5
      Threshold: 70
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref HaWebAutoScalingGroup
      TreatMissingData: notBreaching

Outputs:
  HaWebAlbDnsName:
    Description: DNS name of the Application Load Balancer. Use it to test HTTP.
    Value: !GetAtt HaWebApplicationLoadBalancer.DNSName

  HaWebVpcId:
    Description: VPC ID.
    Value: !Ref HaWebVpc

  HaWebAutoScalingGroupName:
    Description: Auto Scaling group name.
    Value: !Ref HaWebAutoScalingGroup

  HaWebDynamoDbTableName:
    Description: DynamoDB table name.
    Value: !Sub '${ResourcePrefix}-ddb'
